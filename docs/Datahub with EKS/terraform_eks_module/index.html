<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/til/blog/rss.xml" title="Wonjun&#39;s Today I Learned RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/til/blog/atom.xml" title="Wonjun&#39;s Today I Learned Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-KNXFDH361W","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-react-helmet="true">EKS Datahub 4 Terraform EKS Module | Wonjun&#x27;s Today I Learned</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://wonjun0120/github.io/til/docs/Datahub with EKS/terraform_eks_module"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="EKS Datahub 4 Terraform EKS Module | Wonjun&#x27;s Today I Learned"><meta data-react-helmet="true" name="description" content="Tags: aib-datateam, aws, datahub, eks, engineering-log, kubernetes, terraform, traefik"><meta data-react-helmet="true" property="og:description" content="Tags: aib-datateam, aws, datahub, eks, engineering-log, kubernetes, terraform, traefik"><link data-react-helmet="true" rel="icon" href="/til/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://wonjun0120/github.io/til/docs/Datahub with EKS/terraform_eks_module"><link data-react-helmet="true" rel="alternate" href="https://wonjun0120/github.io/til/docs/Datahub with EKS/terraform_eks_module" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://wonjun0120/github.io/til/docs/Datahub with EKS/terraform_eks_module" hreflang="x-default"><link rel="stylesheet" href="/til/assets/css/styles.8d002642.css">
<link rel="preload" href="/til/assets/js/runtime~main.808d207f.js" as="script">
<link rel="preload" href="/til/assets/js/main.4442a007.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/til/"><b class="navbar__title">Wonjun&#x27;s TIL</b></a><a class="navbar__item navbar__link navbar__link--active" href="/til/docs/intro">Project Logs</a><a class="navbar__item navbar__link" href="/til/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/wonjun0120" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/til/docs/intro">Project Log</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/til/docs/Datahub with EKS/aws_setting">Datahub with EKS</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/til/docs/Datahub with EKS/aws_setting">EKS Datahub 1 AWS Setting</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/til/docs/Datahub with EKS/terraform_basic_setting">EKS Datahub 2 Terraform 초기 세팅</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/til/docs/Datahub with EKS/terraform_network_module">EKS Datahub 3 Terraform Network Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/til/docs/Datahub with EKS/terraform_eks_module">EKS Datahub 4 Terraform EKS Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/til/docs/Datahub with EKS/terraform_argocd_module">EKS Datahub 5 Terraform ArgoCD Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/til/docs/Datahub with EKS/argocd_deploy">EKS Datahub 6 ArgoCD로 Datahub 배포</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/til/docs/Noterest/intro">Noterest</a></div></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>EKS - Datahub - 4 Terraform EKS Module</h1></header><p>Tags: aib-datateam, aws, datahub, eks, engineering-log, kubernetes, terraform, traefik</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="래퍼런스">래퍼런스<a class="hash-link" href="#래퍼런스" title="Direct link to heading">​</a></h3><p>여기서는 아래 책을 참고하여 진행하였습니다. </p><p><a href="http://www.yes24.com/Product/Goods/102805240" target="_blank" rel="noopener noreferrer">처음 시작하는 마이크로서비스 - YES24</a></p><p>Terraform, EKS, Traefik, Argocd 등 전반적으로 다 알려주고 있습니다!
혹시나 관심있으신 분들은 꼭 읽어보시는 것을 추천드립니다!</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="eks를-시작하기-전에">EKS를 시작하기 전에..<a class="hash-link" href="#eks를-시작하기-전에" title="Direct link to heading">​</a></h3><p>EKS(Elastic Kubernetes Service)는 AWS에서 제공하는 관리형 쿠버네티스 서비스입니다.</p><p>EKS를 사용하면 쿠버네티스의 설치부터, 운영을 EKS가 대신 해줍니다.</p><p>쿠버네티스의 구현은 매우 복잡하며, 가능한 빠르게 시스템을 설정하고 실행하기 위해서 EKS를 사용합니다.</p><p>❓ 쿠버네티스?</p><p><a href="https://kubernetes.io/ko/docs/concepts/overview/what-is-kubernetes/" target="_blank" rel="noopener noreferrer">쿠버네티스란 무엇인가?</a></p><blockquote><p>예를 들어 컨테이너가 다운되면 다른 컨테이너를 다시 시작해야 한다. 이 문제를 시스템에 의해 처리한다면 더 쉽지 않을까? 그것이 쿠버네티스가 필요한 이유이다! <strong>쿠버네티스는 분산 시스템을 탄력적으로 실행하기 위한 프레임 워크를 제공한다</strong>. 애플리케이션의 확장과 장애 조치를 처리하고, 배포 패턴 등을 제공한다. 예를 들어, 쿠버네티스는 시스템의 카나리아 배포를 쉽게 관리 할 수 있다.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_y2LR" id="모듈-생성">모듈 생성<a class="hash-link" href="#모듈-생성" title="Direct link to heading">​</a></h3><p>EKS역시 테라폼으로 관리할 예정이기에 EKS에 관련된 테라폼 코드 역시 모듈로 관리합니다. </p><p><code>eks_module</code> 폴더를 생성하고 코드를 작성할 파일들을 생성합니다.</p><p>파일 이름은 네트워크 모듈 생성할 때 사용했던 파일 이름을 그대로 사용합니다.</p><p><code>main.tf</code> : 모듈이 실행되는 파일</p><p><code>variables.tf</code> : 모듈의 input값을 관리하는 파일</p><p><code>outputs.tf</code> :모듈의 output값을 관리하는 파일, 만약 output이 없는 경우 해당 파일 생성을 하지 않을 수 있습니다.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="outputtf"><code>output.tf</code><a class="hash-link" href="#outputtf" title="Direct link to heading">​</a></h3><blockquote><p>EKS 모듈이 제공하는 출력 변수를 선언하는 파일입니다.</p></blockquote><div class="codeBlockContainer_J+bg language-HCL theme-code-block"><div class="codeBlockContent_csEI HCL"><pre tabindex="0" class="prism-code language-HCL codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;eks_cluster_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = aws_eks_cluster.aib-cluster.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;eks_cluster_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = aws_eks_cluster.aib-cluster.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;eks_cluster_certificate_data&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = aws_eks_cluster.aib-cluster.certificate_authority.0.data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;eks_cluster_endpoint&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = aws_eks_cluster.aib-cluster.endpoint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;eks_cluster_nodegroup_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = aws_eks_node_group.node-group.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;eks_cluster_security_group_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = aws_security_group.cluster.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>EKS 모듈을 통해 생성한 EKS 정보들을 반환할 수 있도록 구성합니다.</p><p>생성된 EKS의 클러스터 id, 클러스터 이름, 클러스터 인증서, 클러스터 엔드포인트, 클러스터 노드 그룹 id, 클러스터 보안 그룹 id를 반환합니다.</p><p>이렇게 출력된 변수들은 다른 모듈에서 해당 클러스터에 접근 할 수 있도록 합니다.</p><p>다음 글에서 작성될 ArgoCD를 해당 클러스터에 설치할 때 EKS의 엔드포인트와 인증서가 필요합니다. </p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="maintf"><code>main.tf</code><a class="hash-link" href="#maintf" title="Direct link to heading">​</a></h3><blockquote><p>EKS 클러스터가 정의되어있는 파일입니다.</p></blockquote><div class="codeBlockContainer_J+bg language-HCL theme-code-block"><div class="codeBlockContent_csEI HCL"><pre tabindex="0" class="prism-code language-HCL codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">provider &quot;aws&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region = var.aws_region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>공급자 정의를 합니다. </p><p>AWS의 EKS를 사용하므로 AWS 공급자를 정의합니다.</p><p>모듈이 호출될 때 리전 정보를 받아올 수 있도록 하였습니다. 외부에서 여러 모듈을 실행하는 경우 서로 같은 리전에서 실행될 수 있도록 하며, 유지보수성을 높일 수 있습니다. </p><div class="codeBlockContainer_J+bg language-HCL theme-code-block"><div class="codeBlockContent_csEI HCL"><pre tabindex="0" class="prism-code language-HCL codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_iam_role&quot; &quot;cluster&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = var.cluster_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  assume_role_policy = &lt;&lt;POLICY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;Version&quot;: &quot;2012-10-17&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;Statement&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;Effect&quot;: &quot;Allow&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;Principal&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;Service&quot;: &quot;eks.amazonaws.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;Action&quot;: &quot;sts:AssumeRole&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POLICY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_iam_role_policy_attachment&quot; &quot;cluster-AmazonEKSClusterPolicy&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  policy_arn = &quot;arn:aws:iam::aws:policy/AmazonEKSClusterPolicy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role       = aws_iam_role.cluster.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>EKS를 실행하려면 AWS 리소스를 생성하고 수정할 수 있는 권한이 있어야합니다.</p><p>위 코드를 통해 EKS서비스에 대한 새로운 자격 증명과 접근 정책을 정의하고 <code>[AmazoneEKSClusterPolicy](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/service_IAM_role.html)</code> 정책을 연결합니다.</p><p><code>[aws_iam_role](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role)</code> 테라폼 리소스를 사용하여 aws 역할을 생성합니다. </p><p>이후 <code>[aws_iam_role_policy_attachment](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy_attachment)</code> 테라폼 리소스를 통해 생성한 aws 역할에  <code>[AmazoneEKSClusterPolicy](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/service_IAM_role.html)</code> 정책을 연결합니다.</p><p>참고 레퍼런스</p><p><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/service_IAM_role.html" target="_blank" rel="noopener noreferrer">Amazon EKS 클러스터 IAM 역할</a></p><p>여기서 사용되는 클러스터 이름은 다른 곳에서도 사용되므로 변수로 관리합니다.</p><p>클러스터 서비스의 역할과 정책을 정의하였으므로, 다음에는 클러스터에 대한 네트워크 보안 정책을 정의합니다.</p><div class="codeBlockContainer_J+bg language-HCL theme-code-block"><div class="codeBlockContent_csEI HCL"><pre tabindex="0" class="prism-code language-HCL codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_security_group&quot; &quot;cluster&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name        = var.cluster_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Cluster communication with worker nodes&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vpc_id      = var.vpc_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingress {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    description = &quot;Inbound traffic from within the security group&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from_port   = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    to_port     = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol    = &quot;-1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self        = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  egress {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from_port   = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    to_port     = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol    = &quot;-1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self        = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Owner       = &quot;aib&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Environment = &quot;dev&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>이전에 정의한 네트워크 모듈을 통해 생성된 VPC 정보를 사용하여 클러스터의 네트워크 보안 정책을 생성합니다.</p><p><code>[aws_security_group](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group)</code> 테라폼 리소스를 통해 보안그룹을 생성할 수 있습니다. </p><p>이렇게 정책과 보안그룹을 정의하였으면, 이를 이용하여 EKS 클러스터를 생성할 수 있습니다.</p><div class="codeBlockContainer_J+bg language-python theme-code-block"><div class="codeBlockContent_csEI python"><pre tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">&quot;aws_eks_cluster&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;aib-cluster&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> var</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cluster_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role_arn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aws_iam_role</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vpc_config </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    security_group_ids </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">aws_security_group</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subnet_ids         </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> var</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cluster_subnet_ids</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aws_iam_role_policy_attachment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cluster</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">AmazonEKSClusterPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>[aws_eks_cluster](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/eks_cluster)</code> 테라폼 리소스를 사용하여 EKS 클러스터를 정의할 수 있습니다. </p><p>클러스터의 이름과, 앞서 정의한 정책, 보안그룹, 그리고 네트워크 모듈을 통해 생성한 서브넷들을 연결해줍니다.</p><p>이렇게 EKS 클러스터를 생성하면 쿠버네티스 클러스터를 생성하기 위해 필요한 모든 관리 구성 요소가 자동으로 설정됩니다. 그리고 이는 쿠버네티스 시스템에서 두뇌 역할을 하는 <a href="https://kubernetes.io/ko/docs/concepts/overview/components/#%EC%BB%A8%ED%8A%B8%EB%A1%A4-%ED%94%8C%EB%A0%88%EC%9D%B8-%EC%BB%B4%ED%8F%AC%EB%84%8C%ED%8A%B8" target="_blank" rel="noopener noreferrer">컨트롤 플레인</a>의 역할을 합니다.</p><p>이제는 컨트롤 플레인과 함께 여러 서비스들이 실행될 장소, 노드들이 필요합니다. </p><p>노드 역시 테라폼으로 정의합니다.</p><p>정의하기 전 EKS 클러스터를 생성하기 전에 역할을 생성해주었듯이 노드 역시 역할이 필요합니다.</p><p>노드 생성에 사용할 역할을 먼저 생성해줍니다.</p><div class="codeBlockContainer_J+bg language-HCL theme-code-block"><div class="codeBlockContent_csEI HCL"><pre tabindex="0" class="prism-code language-HCL codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_iam_role&quot; &quot;node&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;${var.cluster_name}.node&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  assume_role_policy = &lt;&lt;POLICY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;Version&quot;: &quot;2012-10-17&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;Statement&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;Effect&quot;: &quot;Allow&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;Principal&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;Service&quot;: &quot;ec2.amazonaws.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;Action&quot;: &quot;sts:AssumeRole&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POLICY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_iam_role_policy_attachment&quot; &quot;node-AmazonEKSWorkerNodePolicy&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  policy_arn = &quot;arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role       = aws_iam_role.node.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_iam_role_policy_attachment&quot; &quot;node-AmazonEKS_CNI_Policy&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  policy_arn = &quot;arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role       = aws_iam_role.node.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_iam_role_policy_attachment&quot; &quot;node-AmazonEC2ContainerRegistryReadOnly&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  policy_arn = &quot;arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  role       = aws_iam_role.node.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>[aws_iam_role](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role)</code> 테라폼 리소스를 사용하여 aws 역할을 생성합니다. </p><p>이후 <code>[aws_iam_role_policy_attachment](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy_attachment)</code> 테라폼 리소스를 통해 생성한 aws 역할에 필요한 정책을 연결합니다.</p><p>해당 역할에 연결되는 정책은 <code>AmazonEKSWorkerNodePolicy</code>, <code>AmazonEKS_CNI_Policy</code> , <code>AmazonEC2ContainerRegistryReadOnly</code> 입니다.</p><p>참고 레퍼런스 </p><p><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/create-node-role.html" target="_blank" rel="noopener noreferrer">Amazon EKS 노드 IAM 역할</a></p><p><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-iam-role.html" target="_blank" rel="noopener noreferrer">서비스 계정에 IAM 역할을 사용하도록 Amazon VPC CNI 플러그인 구성</a></p><p>정책 생성후 EKS 노드 그룹을 정의할 수 있습니다.</p><div class="codeBlockContainer_J+bg language-HCL theme-code-block"><div class="codeBlockContent_csEI HCL"><pre tabindex="0" class="prism-code language-HCL codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;aws_eks_node_group&quot; &quot;node-group&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cluster_name    = aws_eks_cluster.aib-cluster.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  node_group_name = &quot;aib-eks&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  node_role_arn   = aws_iam_role.node.arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  subnet_ids      = var.nodegroup_subnet_ids</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  scaling_config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    desired_size = var.nodegroup_desired_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_size     = var.nodegroup_max_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    min_size     = var.nodegroup_min_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  disk_size      = var.nodegroup_disk_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  instance_types = var.nodegroup_instance_types</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aws_iam_role_policy_attachment.node-AmazonEKSWorkerNodePolicy,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aws_iam_role_policy_attachment.node-AmazonEKS_CNI_Policy,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aws_iam_role_policy_attachment.node-AmazonEC2ContainerRegistryReadOnly,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>[aws_eks_node_group](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/eks_node_group)</code> 테라폼 리소스를 사용하여 노드그룹을 정의합니다.</p><p>노드그룹을 정의하는데 사용되는 정보</p><p><code>cluster_name</code> : EKS 클러스터 이름, 변수로 사용합니다.</p><p><code>node_group_name</code> : 노드 그룹의 이름</p><p><code>node_role_arn</code> : 노드의 정책, 위에서 생성한 역할을 사용합니다.</p><p><code>subnet_ids</code> : 서브넷 아이디들, 네트워크 모듈로 생성된 서브넷을 사용합니다.</p><p><code>scaling_config</code> : 노드의 스케일 정의</p><p><code>desired_size</code> : 워커 노드의 갯수</p><p><code>max_size</code> : 워커 노드의 최댓값</p><p><code>min_size</code> : 워커 노드의 최솟값</p><p><code>disk_size</code> : 워커 노드의 디스크 사이즈 </p><p><code>instance_types</code> : 워커 노드의 인스턴스 사이즈, <code>t3.medium</code> 이 기본 값</p><p><code>depends_on</code> : 워커 노드와 연결될 정책들, 위에서 생성한 정책을 연결해줍니다.</p><p>사용되는 대부분의 값들을 변수로 받아서 사용하게 구성하였습니다.</p><p>해당 모듈 외부에서 쉽게 값을 확인하고 변경할 수 있습니다.</p><p>노드 그룹들에 대해서 정의를 하였다면 EKS에 대한 설정은 끝입니다.</p><p>마지막으로는 EKS로 생성된 쿠버네티스 관리에 사용되는 kubectl을 사용할 수 있도록
kubectl의 구성을 위해 세부 연결 정보를 제공하는 작업이 필요합니다.</p><aside>❓ kubectl?<p><a href="https://kubernetes.io/ko/docs/reference/kubectl/overview/" target="_blank" rel="noopener noreferrer">kubectl 개요</a></p><p>쿠버네티스 클러스터를 제어할 수 있는 커멘드 라인 도구입니다.
사용을 하기 위해서는 <a href="https://kubernetes.io/ko/docs/concepts/configuration/organize-cluster-access-kubeconfig/" target="_blank" rel="noopener noreferrer">kubeconfig</a> 파일을 통해 쿠버네티스와 kubectl 연결이 필요합니다.</p></aside><div class="codeBlockContainer_J+bg language-python theme-code-block"><div class="codeBlockContent_csEI python"><pre tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">resource </span><span class="token string" style="color:#e3116c">&quot;local_file&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;kubeconfig&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  content  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain">KUBECONFIG</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> cluster</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    certificate</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">authority</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">aws_eks_cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">aib</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">certificate_authority</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">0.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">aws_eks_cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">aib</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">endpoint</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">aws_eks_cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">aib</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">arn</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">contexts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">aws_eks_cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">aib</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">arn</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    user</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">aws_eks_cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">aib</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">arn</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">aws_eks_cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">aib</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">arn</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">current</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">aws_eks_cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">aib</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">arn</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">preferences</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">users</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">aws_eks_cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">aib</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cluster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">arn</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">exec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">authentication</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k8s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aws</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">iam</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">authenticator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      args</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;token&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-i&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;${aws_eks_cluster.aib-cluster.name}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KUBECONFIG</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filename </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;kubeconfig&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>[local_file](https://registry.terraform.io/providers/hashicorp/local/latest/docs/resources/file)</code> 테라폼 리소스를 사용하여 위에서 생성된 EKS 정보들을 바탕으로 kubeconfig파일을 작성하고 로컬로 내려받을 수 있도록 코드를 작성합니다.</p><p><a href="https://kubernetes.io/ko/docs/tasks/access-application-cluster/configure-access-multiple-clusters/" target="_blank" rel="noopener noreferrer">다중 클러스터 접근 구성</a></p><p>위 레퍼런스를 통해서 <code>kubectl</code> 에서 사용하는 <code>kubeconfig</code> 파일을 생성하는 방법을 확인할 수 있습니다.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="variabletf"><code>variable.tf</code><a class="hash-link" href="#variabletf" title="Direct link to heading">​</a></h3><blockquote><p>위 <code>main.tf</code> 파일에서 사용한 변수들을 여기서 정의합니다.</p></blockquote><div class="codeBlockContainer_J+bg language-HCL theme-code-block"><div class="codeBlockContent_csEI HCL"><pre tabindex="0" class="prism-code language-HCL codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;aws_region&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;AWS region ID for deployment (e.g. ap-northeast-2)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = &quot;ap-northeast-2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;env_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;cluster_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;vpc_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;cluster_subnet_ids&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = list(string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;nodegroup_subnet_ids&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = list(string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;nodegroup_desired_size&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type    = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;nodegroup_min_size&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type    = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;nodegroup_max_size&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type    = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default = 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;nodegroup_disk_size&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;nodegroup_instance_types&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = list(string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="eks-모듈-사용">EKS 모듈 사용<a class="hash-link" href="#eks-모듈-사용" title="Direct link to heading">​</a></h3><p>EKS 모듈을 구성했다면 이제 외부에서 사용해야합니다.</p><p>이전 테라폼 백엔드를 선언했던 <code>main.tf</code> 파일에서 네트워크 모듈을 사용해줍니다.</p><p><code>variable.tf</code> 파일에 선언되어있는 변수들에 값을 전부 넣어주어야합니다.</p><div class="codeBlockContainer_J+bg language-HCL theme-code-block"><div class="codeBlockContent_csEI HCL"><pre tabindex="0" class="prism-code language-HCL codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">module &quot;aws-kubernetes-cluster&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source = &quot;./eks_module&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  env_name           = local.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  aws_region         = local.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cluster_name       = local.k8s_cluster_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vpc_id             = module.aws-network.vpc_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cluster_subnet_ids = module.aws-network.subnet_ids</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nodegroup_subnet_ids     = module.aws-network.private_subnet_ids</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nodegroup_disk_size      = &quot;20&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nodegroup_instance_types = [&quot;t3.medium&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nodegroup_desired_size   = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nodegroup_min_size       = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nodegroup_max_size       = 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>디스크 사이즈는 20GB, 노드그룹의 인스턴스 타입은 기본값인 <code>t3.medium</code> 을 사용하였습니다.</p><p>노드그룹의 사이즈는 2, 최솟값1, 최댓값은 5로 구성하였습니다.</p><p>추후 <a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cluster-autoscaler.html" target="_blank" rel="noopener noreferrer">autoscaler</a> 추가를 통해 EKS에서 노드그룹의 사이즈를 적절하게 조절할 수 있도록 구성하려합니다.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="마무리">마무리<a class="hash-link" href="#마무리" title="Direct link to heading">​</a></h3><p>위에 있는 테라폼 코드를 전부 작성하였다면 테라폼 명령어를 입력할 차례입니다.</p><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">terraform </span><span class="token function" style="color:#d73a49">fmt</span><span class="token plain"> </span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform validate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform plan</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>코드 테스트 후 문제가 없다는 것을 확인하였다면 apply를 해줍니다</p><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">terraform apply</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>테라폼이 실행된 후 클러스터가 정상적으로 생성되었는지 확인해볼 수 있습니다.</p><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">aws eks list-clusters</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/til/docs/tags/aws">AWS</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/til/docs/tags/eks">EKS</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/til/docs/tags/terraform">Terraform</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/til/docs/tags/datahub-with-eks">Datahub with EKS</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://wonjun0120/github.io/til/docs/docs/Datahub with EKS/TerraformEKSModule.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/til/docs/Datahub with EKS/terraform_network_module"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">EKS Datahub 3 Terraform Network Module</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/til/docs/Datahub with EKS/terraform_argocd_module"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">EKS Datahub 5 Terraform ArgoCD Module</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#래퍼런스" class="table-of-contents__link toc-highlight">래퍼런스</a></li><li><a href="#eks를-시작하기-전에" class="table-of-contents__link toc-highlight">EKS를 시작하기 전에..</a></li><li><a href="#모듈-생성" class="table-of-contents__link toc-highlight">모듈 생성</a></li><li><a href="#outputtf" class="table-of-contents__link toc-highlight"><code>output.tf</code></a></li><li><a href="#maintf" class="table-of-contents__link toc-highlight"><code>main.tf</code></a></li><li><a href="#variabletf" class="table-of-contents__link toc-highlight"><code>variable.tf</code></a></li><li><a href="#eks-모듈-사용" class="table-of-contents__link toc-highlight">EKS 모듈 사용</a></li><li><a href="#마무리" class="table-of-contents__link toc-highlight">마무리</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/til/docs/intro">Project Logs</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/til/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/wonjun0120" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 wonjun0120, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/til/assets/js/runtime~main.808d207f.js"></script>
<script src="/til/assets/js/main.4442a007.js"></script>
</body>
</html>